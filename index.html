<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Escher Annotation</title>

    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" href="css/scroller.bootstrap4.min.css" />
    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css" />
    <link rel="stylesheet" href="css/fontawesome.min.css" />
    <link rel="stylesheet" href="css/solid.min.css" />
    <link rel="stylesheet" href="css/regular.min.css" />
    <link rel="stylesheet" href="css/select2.min.css" />
    <link rel="stylesheet" href="css/seed.css" />
    <link rel="stylesheet" href="css/builder.css" />
    <link rel="stylesheet" href="css/builder-bootstrap.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

    <style>
      .omg {
        position: absolute;
        left: 3px;
        /*top: 5%;*/
        margin-top: 50px;
        padding-left: 0;
        z-index: 1;
      }
        html, body {
    height: 100%;
    width: 100%;
    margin: 0;
  }
        #map_container{
            /* background-color: black; */
            flex-grow : 1;
            height: 100%;
        }
     .axis path,
     .axis line {
       fill: none;
       stroke: #000;
       shape-rendering: crispEdges;
     }

     .bar {
       fill: steelblue;
     }

     .x.axis path {
       display: none;
     }

        .wutt {
          padding-left: 0px !important;
          padding-right: 0px !important;
            display: flex;
    flex-flow: column;
    height: 100%;
        }


    .demo-droppable {
      background: #08c;
      color: #fff;
      padding: 100px 0;
      text-align: center;
    }
    .demo-droppable.dragover {
      background: #00CC71;
    }

      .nav-space > li {
        margin: 1px;
      }

    </style>
  </head>
  
  <body>


    <div class="container-fluid wutt">
      <div id="top_bar" class="top-bar-seed">

        <!--
        <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#exampleModal"> Settings</button>

        <a href="#" data-toggle="modal" data-target="#exampleModal" class="badge-seed-large badge-seed">
          <i class="fas fa-map"></i> Map
        </a>

        <a href="#" data-toggle="modal" data-target="#model_annotation_help" class="badge-seed-large badge-seed">
          <i class="fas fa-question-circle"></i> Help
        </a>
        <a href="#" data-toggle="modal" data-target="#modal-settings" class="badge-seed-large badge-seed">
          <i class="fas fa-cog"> </i> Settings
        </a>
        -->
        Biochemistry: <span id="label_model" class="badge badge-danger">ModelSEED</span>
        Map: <span id="label_map" class="badge badge-danger">example_map</span>

        <!--
          <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modal_data_load"><i class="fas fa-bars"> </i> Load Data</button>
          <button type="button" class="btn btn-seed-sm btn-dark"><i class="fas fa-cog"> </i> Edit </button>


          Display: <button id="display_toggle" type="button" class="btn btn-seed-sm btn-dark"><i class="fas fa-cog"> </i> ID </button>
    -->

      </div>

      <div id="left_panel" class="escher_right_panel"></div>
      <div class="escher-container omg">
        <ul class="nav nav-pills nav-space">
          <li>
            <a href="#" data-toggle="modal" data-target="#modal-settings" class="btn btn-default simple-button" title="Settings">
              <i class="fas fa-cog"> </i>
            </a>
          </li>
          <li>
            <a href="#" data-toggle="modal" data-target="#model_annotation_help" class="btn btn-default simple-button" title="Help">
              <i class="fas fa-question-circle"></i>
            </a>
          </li>
          <li>
            <a href="#" data-toggle="modal" data-target="#exampleModal" class="btn btn-default simple-button" title="Map Catalog">
              <i class="fas fa-map"></i>
            </a>
          </li>
          <li>
            <label for="upload" class="btn btn-default simple-button" style="cursor: pointer">
              <i class="fas fa-upload"></i>
              <input type="file" id="upload" style="display:none">
            </label>
          </li>
          <li>
            <label for="download" class="btn btn-default simple-button" style="cursor: pointer">
              <i class="fas fa-download"></i>
              <input type="file" id="downloadx" style="display:none">
            </label>
          </li>
          <li>
            <button id="btn_test"  class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-angry"></i>
            </button>
          </li>
          <li>
            <button class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-flask"></i>
            </button>
          </li>
          <li>
            <button class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-vial"></i>
            </button>
          </li>
          <li>
            <button class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-seedling"></i>
            </button>
          </li>
          <li>
            <button class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-route"></i>
            </button>
          </li>
          <li>
            <button class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-dna"></i>
            </button>
          </li>
          <li>
            <button class="btn btn-default simple-button" title="Download Map">
              <i class="fas fa-microscope"></i>
            </button>
          </li>
        </ul>
      </div>
      <div id="map_container">Loading map ...</div>
    </div>

<!-- Modal Map Select-->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog mw-100 w-75" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModal_Label">Metabolic Maps</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <!-- 
    <button type="button" class="btn btn-primary" onclick="test()">test</button>
-->
            <table id="table-escher-maps" class="table table-sm">
              <thead class="thead-light">
                  <tr>
                    <th scope="col">Dataset</th>
                    <th scope="col">Map</th>
                    <th scope="col">#compounds</th>
                    <th scope="col">#reactions</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
            </table>
      </div>
      <div class="modal-footer">
          
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> 
          <!-- 
        <button type="button" class="btn btn-primary">Save changes</button>
-->
      </div>
    </div>
  </div>
</div>



<!-- Modal Data Load-->
<div class="modal fade" id="modal_data_load" tabindex="-1" role="dialog" aria-labelledby="modal_data_load_label" aria-hidden="true">
  <div class="modal-dialog mw-100 w-75" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Load Data</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <a class="btn" id="download_map" target="_blank">Download CSV (via btoa)</a>
    <button type="button" class="btn btn-primary" onclick="test()">test</button>

        !!!!!
<div id="dropzone_load_model" style="height:200px; width:200px">
Load Model
</div>
<div id="dropzone_load_map" style="height:200px; width:200px">
Load Map
</div>        
<form action="your_action" class="dropzone" id="your_form_id">
     <div class="fallback">
         <input name="file" type="file" />
     </div>
</form>

<button type="button" id="btn_upload">Upload</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

    <!-- Modal Settings-->
    <div class="modal fade" id="modal-settings" tabindex="-1" role="dialog" aria-labelledby="modal-settings-label" aria-hidden="true">
      <div class="modal-dialog mw-100 w-75" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modal-settings-label">Load Data</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">

            <ul class="nav nav-tabs" id="tab-group-settings" role="tablist">
              <li class="nav-item" role="presentation">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">System</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="biochem-tab" data-toggle="tab" href="#settings-biochem" role="tab" aria-controls="profile" aria-selected="false">Biochemistry</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="map-tab" data-toggle="tab" href="#settings-map" role="tab" aria-controls="profile" aria-selected="false">Map</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Tooltip</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Export Template</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="cpd-map-tab" data-toggle="tab" href="#settings-cpd-map" role="tab" aria-controls="contact" aria-selected="false">Compound Map</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="kbase-tab" data-toggle="tab" href="#settings-kbase" role="tab" aria-controls="contact" aria-selected="false"><img src="media/k-base_logo.svg" alt="KBase" height="20px"></a>
              </li>
            </ul>
            <div class="tab-content" id="tab-content-settings">
              <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <iframe src="config.html" style="width: 100%; height: 500px"></iframe>
              </div>

              <div class="tab-pane fade" id="settings-biochem" role="tabpanel" aria-labelledby="biochem-tab">
                <div>
                <label for="settings-biochem-config">Compartment Config</label>
                <input type="text" class="form-control" id="settings-biochem-config" value="0:c" required>
                <button id="settings-biochem-build" class="btn btn-success">Set</button>
                </div>

                <div>
                <label for="select_model">SBML Model</label>
                <div id="select_model"></div>

                <label for="select_model_cmp">SBML Compartment</label>
                <div id="select_model_cmp"></div>
                </div>
              </div>

              <div class="tab-pane fade" id="settings-map" role="tabpanel" aria-labelledby="map-tab">
                <div class="container-fluid">
                  <div class="row">
                    <div class="col-md-12"></div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <form target="#">
                        <div class="form-row">
                          <label for="settings-map-meta-name">Map Name</label>
                          <input type="text" class="form-control" id="settings-map-meta-name" required>
                        </div>
                        <div class="form-row">
                          <label for="settings-map-meta-desc">Map Description</label>
                          <input type="text" class="form-control" id="settings-map-meta-desc">
                        </div>
                        <div class="form-row">
                          <label for="settings-map-meta-authors">Authors</label>
                          <input type="text" class="form-control" id="settings-map-meta-authors">
                        </div>
                      </form>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <label for="download" class="badge-seed-large badge-seed" style="cursor: pointer">
                        <i class="fas fa-download"></i> Download Map
                        <input type="file" id="download" style="display:none">
                      </label>
                      <a href="#" class="badge-seed-large badge-seed">
                        <i class="fas fa-save"></i> Save Map
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <div id="fn-tooltip-options">

                </div>
                <button onclick="widget_escher.fn_tooltip_rxn = widget_escher.fn_tooltip_options.reaction.annotation">annotation</button>
                <button onclick="widget_escher.fn_tooltip_rxn = widget_escher.fn_tooltip_options.reaction.default">default</button>
              </div>

              <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                <form target="#">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="export-namespace">Annotation Namespace</label>
                      <input type="text" class="form-control" id="export-namespace" aria-describedby="export-namespace-help" required>
                      <small id="export-namespace-help" class="form-text text-muted">Annotation Namespace to export</small>
                    </div>
                    <div class="form-group col-md-6">
                      <div style="margin: 20px">
                        <div>
                          <input id="filter_reactions_to_map" type="checkbox">
                          <label for="filter_reactions_to_map">Export only reactions in current map</label>
                        </div>
                        <div>
                          <input id="clear_template_reactions" type="checkbox">
                          <label for="clear_template_reactions">Clear previous reactions</label>
                        </div>
                        <div>
                          Clear previous roles and/or complexes:<br>
                          <input type="radio" id="rad-clear_role_complex-none"
                                 name="clear_role_complex" value="none" checked>
                          <label for="rad-clear_role_complex-none">None</label>

                          <input type="radio" id="rad-clear_role_complex-cpx"
                                 name="clear_role_complex" value="cpx">
                          <label for="rad-clear_role_complex-cpx">Complexes</label>

                          <input type="radio" id="rad-clear_role_complex-ftr"
                                 name="clear_role_complex" value="ftr">
                          <label for="rad-clear_role_complex-ftr">Roles and Complexes</label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="export-in-id">Input ID</label>
                      <input type="text" class="form-control" id="export-in-id" required>
                    </div>
                    <div class="form-group col-md-6">
                      <label for="export-in-ws">Input Workspace</label>
                      <input type="text" class="form-control" id="export-in-ws" required>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="export-in-id">Output ID</label>
                      <input type="text" class="form-control" id="export-out-id" required>
                    </div>
                    <div class="form-group col-md-6">
                      <label for="export-in-ws">Output Workspace</label>
                      <input type="text" class="form-control" id="export-out-ws" required>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-md-12">
                      <label for="export-token">KBase TOKEN</label>
                      <input type="password" class="form-control" id="export-token" aria-describedby="export-token-help" required>
                      <small id="export-token-help" class="form-text text-muted">KBase Auth Token</small>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary" id="export-button">Export</button>
                </form>
              </div>

              <div class="tab-pane fade" id="settings-cpd-map" role="tabpanel" aria-labelledby="cpd-map-tab">
                DO NOT TOUCH THIS ! (under dev)
                <button onclick="table_mapping_widget.button_fn_cluster_report()">yay</button>
                <div id="container-cpd-mapping-table"></div>
                <button onclick="table_mapping_widget.button_fn_cluster_accept()">push mapping</button>
                <button onclick="get_merge_model_test()">get merge model</button>
                <button onclick="seed_model()">get seed model</button>
              </div>
              <div class="tab-pane fade" id="settings-kbase" role="tabpanel" aria-labelledby="kbase-tab">
                kbase
                <input id="narrative"><button id="show_narrative">list narrative</button>
                <table id="table-kbase-narrative" class="table">
                  <thead class="thead-light">
                    <tr>
                      <th scope="col">Object ID</th>
                      <th scope="col">Type</th>
                      <th scope="col">Created</th>
                      <th scope="col">v</th>
                      <th scope="col">User</th>
                      <th scope="col">Size</th>
                      <th scope="col">Metadata</th>
                      <th scope="col">Reference</th>
                      <th scope="col"></th>
                    </tr>
                  </thead>
                </table>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    
      
      <!-- Modal Annotation Help-->
<div class="modal fade" id="model_annotation_help" tabindex="-1" role="dialog" aria-labelledby="model_annotation_help_label" aria-hidden="true">
  <div class="modal-dialog mw-100 w-75" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="model_annotation_help_label">Description of star rating system</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
          Full star rating:
          The role accurately and specifically describes the reaction AND the role is in a SEED subsystem.
          Such roles will be highlighted in bold in the escher tool.
        </p>
        <p>
          Half star rating:
          The role accurately and specifically describes the reaction but the role is not in a current SEED subsystem.
        </p>
        <p>
          Empty star rating:
          The role accurately describes the reaction, but it isn’t specific (e.g. keto-reductase).
          Alternative, the role accurately and specifically describes the reaction but also contains a “hedging”
          word like “putative” or “probable”.
        </p>
        <p>
          When we implement this new template, we will allow users to decide which level of star rating will be used when building or gapfilling a model. By default, only full star ratings will be used to build a model, but users can indicate if they want to accept lower confidence annotations as well.
          Regarding compound roles
          Annotations on such roles will be ignored, so don’t bother setting these at this time.
        </p>
        <h5>Multifunctional Annotation Symbols:</h5>
        <dl>
          <dt>A / B</dt>
          <dd>- multifunctional protein (usually fused) with roles "Both A and B"</dd>
          <dt>A @ B</dt>
          <dd>- multifunctional protein with weak specificity, roles "Both A and B" <br>
            (NOTE: this notation has unfortunately been "overloaded" by the annotators
            for various alternate purposes besides just "weak specificity".)</dd>
          <dt>A; B</dt>
          <dd>- protein of ambiguous function, role "Either A or B"</dd>
          <dt>A => B</dt>
          <dd>- protein with "role A, subtype B"</dd>
          <dt>A # X</dt>
          <dd>- protein with "role A, attached nonpropagating comment X"</dd>
          <dt>A ## X</dt>
          <dd>- protein with "role A, and propagating comment X"</dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
      
  </body>
    
    
  <!-- Escher requires D3.js -->
  <!--<script src="js/d3-3.5.6.min.js"></script>-->
  <script src="js/d3-5.16.0.js"></script>
  <script src="escher.js"></script>
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/underscore-1.9.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/select2.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.dataTables.min.js"></script>
  <script src="js/dataTables.bootstrap4.min.js"></script>
  <script src="js/dataTables.scroller.min.js"></script>
  <script src="js/dropzone.js"></script>
  <script src="js/curation_env.js"></script>
  <script src="js/curation_api.js"></script>
  <script src="js/kbase_api.js"></script>
  <script src="js/biochem_api.js"></script>
  <script src="js/chemdust_api.js"></script>
  <script src="js/tooltip_compound.js"></script>
  <script src="js/widget_system_status.js"></script>
  <script src="js/widget_escher_modelseed.js"></script>
  <script src="js/widget_escher_depict_compound.js"></script>
  <script src="js/widget_escher_left_panel.js"></script>
  <script src="js/widget_escher_plot.js"></script>
  <script src="js/widget_escher_description.js"></script>
  <script src="js/escher_tooltip_annotation.js"></script>
  <script src="js/table_compound_mapping.js"></script>

  <script>


    const get_merge_model_test = function() {
      const model_ids = [
        'iMM904',
        'yeast_8',
        'iCT646',
        'iAL1006',
        'iLC915',
        'iRL766',
        'iSS884',
        'iWV1213',
        'iJDZ836',
        'iMA871',
        'iNL895'];
      api.post_bios_build_merge_model(model_ids, function(res) {
        $('#label_model').html('Fungi Merge Model');
        widget_escher.change_model(res)
      })
    };

    const seed_model = function() {
      const default_model = "data/ModelSEED2.json";
      $.getJSON(default_model, function(res) {
        $('#label_model').html(res['id']);
        widget_escher.change_model(res)
      });
    };



    $('#upload').on('change', function() {
      console.log(this);
      let file = this.files[0];
      let reader = new FileReader();
      console.log(file);
      reader.onload = function(e) {
        widget_escher.change_map(JSON.parse(e.target.result));
      };
      reader.readAsText(file);
    });

    $('#upload_heatmap').on('change', function() {
      console.log(this);
      let file = this.files[0];
      let reader = new FileReader();
      console.log(file);
      reader.onload = function(e) {
        widget_escher_plot.dataset = JSON.parse(e.target.result);
        widget_escher_plot.refresh()
      };
      reader.readAsText(file);
    });

    $('#btn_test').click(function() {
      alert('!')
      //widget_escher.escher_builder.map.save()
    });

    $('#exampleModal').on('hide.bs.modal', function (e) {
      widget_escher.escher_builder.map.key_manager.toggle(true)
    });
    $('#exampleModal').on('show.bs.modal', function (e) {
      widget_escher.escher_builder.map.key_manager.toggle(false)
    });
    $('#modal-settings').on('hide.bs.modal', function (e) {
      widget_escher.escher_builder.map.key_manager.toggle(true)
    });
    $('#modal-settings').on('show.bs.modal', function (e) {
      widget_escher.escher_builder.map.key_manager.toggle(false)
    });
      
    Dropzone.autoDiscover = false;
   var myDropzone = new Dropzone("#dropzone_load_map", { url: "/file/post", autoProcessQueue: false, maxFiles:1});
  myDropzone.on("addedfile", function(file) {
    console.log(file)
    /* Maybe display some more file information on your page */
  });
    var dz = new Dropzone("#your_form_id", { autoProcessQueue: false, maxFiles:1, init:function(e) {
var myDropzone = this;

        $('#btn_upload').on("click", function() {
            myDropzone.processQueue(); // Tell Dropzone to process all queued files.
        });

        // Event to send your custom data to your server
        myDropzone.on("sending", function(file, xhr, data) {
          console.log(file, xhr, data)
            // First param is the variable name used server side
            // Second param is the value, you can add what you what
            // Here I added an input value
            //data.append("your_variable", $('#your_input').val());
        });
    }});
    
  </script>
  <script src="js/annotation.js"></script>
  <script src="js/annotation_config.js"></script>


  <script src="main.js"></script>

</html>
