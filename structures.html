<!DOCTYPE html>
<html>


  <!-- Specify the style for the GUI -->
  <link rel="stylesheet" href="css/bootstrap.css" />
  <link rel="stylesheet" href="css/dataTables.bootstrap4.min.css" />
  <link rel="stylesheet" href="css/scroller.bootstrap4.min.css" />
  <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css" />
  <link rel="stylesheet" href="css/seed.css" />
  <link rel="stylesheet" href="builder.css" />
    
  <style>
      #yourtarget {
  transform:scale(2.0);
  -webkit-transform:scale(2.0);
}
      html, body {
  height: 100%;
  width: 100%;
  margin: 0;
}
      #map_container{
          /* background-color: black; */
          flex-grow : 1;
          /* height: 800px; */
      }
   .axis path,
   .axis line {
     fill: none;
     stroke: #000;
     shape-rendering: crispEdges;
   }

   .bar {
     fill: steelblue;
   }

   .x.axis path {
     display: none;
   }
      
      .wutt {
          display: flex;
  flex-flow: column;
  height: 100%;
      }
  </style>

  <meta charset="utf-8"/>
  <body>
    <div class="container-fluid wutt">
      <div>
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">Settings</button>
          User: <span id="label_user" class="badge badge-primary">loading...</span>
          Template: <span id="label_target_template" class="badge badge-primary">loading...</span>
          Server: <span id="label_server_status" class="badge badge-danger">offline</span>
          Database: <span id="label_database_status" class="badge badge-danger">offline</span>
          Cloud: <span id="label_cloud_status" class="badge badge-danger">offline</span>
      </div>
      <div id="map_container">Loading map ...</div>
    </div>
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog mw-100 w-75" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Metabolic Maps</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
    <button type="button" class="btn btn-primary" onclick="test()">test</button>
            <table id="table-escher-maps" class="table table-sm">
              <thead class="thead-light">
                  <tr>
                    <th scope="col">map</th>
                    <th scope="col">#reactions</th>
                    <th scope="col">#model</th>
                    <th scope="col">#genes</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
            </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
  </body>
    
  <!-- Escher requires D3.js -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
  <script src="escher.js"></script>
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/underscore-1.9.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.dataTables.min.js"></script>
  <script src="js/dataTables.bootstrap4.min.js"></script>
  <script src="js/dataTables.scroller.min.js"></script>
  <script src="js/annotation.js"></script>
  <script src="js/annotation_config.js"></script>
  
  
  <script>
      
      var test_structures = {
          '5aprbu' : 'InChI=1S/C9H17N4O9P/c10-5-7(12-9(18)13-8(5)17)11-1-3(14)6(16)4(15)2-22-23(19,20)21/h3-4,6,14-16H,1-2,10H2,(H2,19,20,21)(H3,11,12,13,17,18)/p-2/t3-,4+,6-/m0/s1',
          '25dhpp@BiGG' : 'InChI=1S/C9H16N5O8P/c10-3-6(13-9(11)14-7(3)17)12-8-5(16)4(15)2(22-8)1-21-23(18,19)20/h2,4-5,8,15-16H,1,10H2,(H2,18,19,20)(H4,11,12,13,14,17)/p-2/t2-,4-,5-,8-/m1/s1',
          '5apru' :  'InChI=1S/C9H15N4O9P/c10-3-6(12-9(17)13-7(3)16)11-8-5(15)4(14)2(22-8)1-21-23(18,19)20/h2,4-5,8,14-15H,1,10H2,(H2,18,19,20)(H3,11,12,13,16,17)/p-2/t2-,4-,5-,8-/m1/s1',
          '25dthpp' : 'InChI=1S/C9H18N5O8P/c10-5-7(13-9(11)14-8(5)18)12-1-3(15)6(17)4(16)2-22-23(19,20)21/h3-4,6,15-17H,1-2,10H2,(H2,19,20,21)(H4,11,12,13,14,18)/p-2/t3-,4+,6-/m0/s1',
          '4r5au' : 'InChI=1S/C9H16N4O6/c10-5-7(12-9(19)13-8(5)18)11-1-3(15)6(17)4(16)2-14/h3-4,6,14-17H,1-2,10H2,(H3,11,12,13,18,19)/t3-,4+,6-/m0/s1',
          'gtp' : 'InChI=1S/C10H16N5O14P3/c11-10-13-7-4(8(18)14-10)12-2-15(7)9-6(17)5(16)3(27-9)1-26-31(22,23)29-32(24,25)28-30(19,20)21/h2-3,5-6,9,16-17H,1H2,(H,22,23)(H,24,25)(H2,19,20,21)(H3,11,13,14,18)/p-4/t3-,5-,6-,9-/m1/s1'
      }
      function get_structure2(id) {
          return test_structures[id]
      }
      
      nnn = null
      function jsonCallback(json){
  console.log(json);
}
      function get_structure(id, node, d, cb) {
          ss = get_structure2(id)
          if (ss) {
              
body = {
	"width" : 300,
	"height" : 300,
	"carbon_symbol" : false,
	"atom_color" : true,
	"atom_number" : false,
	"aromatic_display" : false,
	"structure" : ss
}
              
                $.post({
                  //type: "POST",
                  url: 'http://192.168.1.21:8080/ChemDUST/api/render/svg/inchi',
                  dataType: 'text',
                  data: JSON.stringify(body),
                    contentType:"application/json; charset=utf-8",
                  //jsonpCallback: 'MyJSONPCallback', // specify the callback name if you're hard-coding it
                  success: function(svg_data) {
                      cb(svg_data, d, node)
                  }
                });
          }
          
          return null
      }
      
      function update_escher_node(svg_data, d, node) {
          var img_size = 120;
          nnn = node.node().parentNode
          console.log(node)
             d3.select(node.node().parentNode)
                 // insert the image before the text
               .insert('svg')               .attr('transform', 'translate('
                                + (d.x - img_size / 2) + ','
                                + (d.y - img_size / 2) + ')')               
                 .attr('width', img_size)
               .attr('height', img_size)
          .attr('viewBox', '0 0 ' + img_size + ' ' + img_size)
               .attr('preserveAspectRatio', 'xMinYMin meet').html(svg_data)
          
          
          //THIS IS NOT THE WAY TO DO THIS BUT I HAD TO HAMMER IT!
          d3.select(d3.select(nnn).select('svg').node()).select('svg').attr('width', img_size).attr('height', img_size)
          /*
          d3.select(node.node().parentNode).append('div')
              .style("width", '300px')
              .style("height", '300px').html(svg_data)
              */
          node.remove();
      }
      
   function add_structures () {
       console.log('Loading structures');
       d3.select('#map_container')
         .selectAll('.metabolite-circle')
         .each(function (data) {
             // only apply the transformation to primary nodes
//d3.select('#svgtmp').append('div').html('<svg...')
             if (!data.node_is_primary) return;
           var circle = d3.select(this);
             structure = get_structure(data['bigg_id'], circle, data, update_escher_node)
             
             console.log(structure)
             return;
             // get the circle location
             
             // get the parent node, and add the image
             d3.select(circle.node().parentNode)
                 // insert the image before the text
               .insert('image', 'text')
               .attr('transform', 'translate('
                                + (data.x - img_size / 2) + ','
                                + (data.y - img_size / 2) + ')')
               .attr('width', img_size)
               .attr('height', img_size)
               .attr('preserveAspectRatio', 'xMinYMin meet')
               .attr('xlink:href', 'structure_imgs/' + remove_compartment(data.bigg_id) + '.png');
             // remove the metabolite circle
             circle.remove();
         });
   }
      
      $(function() {
    $.getJSON("bios7.Riboflavin_tiny.json", function(map_data) {
        //$.getJSON("bios7.json", function(model_data) {
          e_model = null
          e_map = map_data
          e_options = {
            //menu: 'zoom',
            enable_editing: true,
            fill_screen: false,
            reaction_styles: ['abs', 'color', 'size', 'text'],
            first_load_callback: add_structures,
            primary_metabolite_radius: 60,
            never_ask_before_quit: true,
          }
          e_builder = escher.Builder(e_map, e_model, null, d3.select('#map_container'), e_options)
        //});
      })
      })
  </script>
</html>
